// ============================================
// TrackX Database Schema - Prisma ORM (MongoDB)
// Multi-tenant organization-based bus tracking system
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// ORGANIZATION MODEL
// Colleges/Schools using TrackX platform
// ============================================
model Organization {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String   // College/School name
  code            String   @unique // Unique join code (e.g., "SRMC2024")
  slug            String   @unique // URL-friendly slug
  logoUrl         String?  // Organization logo
  bannerUrl       String?  // Banner image
  primaryColor    String   @default("#6366f1") // Brand color
  secondaryColor  String   @default("#8b5cf6")
  address         String?
  city            String?
  state           String?
  country         String   @default("India")
  contactEmail    String?
  contactPhone    String?
  website         String?
  
  // Subscription (Legacy - Now fully free)
  subscriptionTier String  @default("FREE") 
  subscriptionEnd  DateTime?
  maxBuses         Int     @default(999)
  maxDrivers       Int     @default(999)
  
  isActive    Boolean  @default(true)
  isVerified  Boolean  @default(false) // Admin verified
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  admins  Admin[]
  drivers Driver[]
  buses   Bus[]

  @@map("organizations")
}

// ============================================
// ADMIN MODEL
// Organization administrators
// ============================================
model Admin {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  email       String    @unique
  password    String
  name        String
  phone       String?
  role        String    @default("ADMIN") // SUPER_ADMIN, ORG_ADMIN, ADMIN
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Organization relation (null for SUPER_ADMIN)
  organizationId String?       @db.ObjectId
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("admins")
}

// ============================================
// DRIVER MODEL
// Bus drivers with tracking capabilities
// ============================================
model Driver {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  email       String    @unique
  password    String
  name        String
  phone       String?
  photoUrl    String?
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Organization relation
  organizationId String?       @db.ObjectId
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  busId   String?  @unique @db.ObjectId
  bus     Bus?     @relation(fields: [busId], references: [id])
  gpsLogs GpsLog[]

  @@map("drivers")
}

// ============================================
// BUS MODEL
// Vehicle information and tracking config
// ============================================
model Bus {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  busNumber   String
  busName     String
  gpsDeviceId String?
  apiKey      String?
  apiKeyHash  String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Organization relation
  organizationId String?       @db.ObjectId
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  driver  Driver?
  gpsLogs GpsLog[]
  stops   BusStop[]

  @@unique([busNumber, organizationId])
  @@map("buses")
}

// ============================================
// BUS STOP MODEL
// Route stops for each bus
// ============================================
model BusStop {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  latitude  Float
  longitude Float
  order     Int      // Order in the route (1, 2, 3...)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  busId String @db.ObjectId
  bus   Bus    @relation(fields: [busId], references: [id], onDelete: Cascade)

  @@index([busId, order])
  @@map("bus_stops")
}

// ============================================
// GPS LOG MODEL
// Historical location data for buses
// ============================================
model GpsLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  latitude  Float
  longitude Float
  speed     Float?
  heading   Float?
  accuracy  Float?
  altitude  Float?
  timestamp DateTime @default(now())
  source    String   @default("DEVICE") // DEVICE, DRIVER_APP

  busId    String  @db.ObjectId
  bus      Bus     @relation(fields: [busId], references: [id], onDelete: Cascade)
  driverId String? @db.ObjectId
  driver   Driver? @relation(fields: [driverId], references: [id])

  @@index([busId, timestamp(sort: Desc)])
  @@map("gps_logs")
}

// ============================================
// SYSTEM CONFIG MODEL
// Global platform-wide settings
// ============================================
model SystemConfig {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  matrixAutoScaling Boolean  @default(true)
  rootCipherLogic  String   @default("AES-512-GCM")
  telemetryPushFreq Int      @default(1000)
  maintenanceMode  Boolean  @default(false)
  updatedAt        DateTime @updatedAt

  @@map("system_configs")
}

// ============================================
// REFRESH TOKEN MODEL
// JWT refresh token storage for revocation
// ============================================
model RefreshToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  token     String   @unique
  userId    String
  userType  String   // ADMIN, DRIVER
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, userType])
  @@map("refresh_tokens")
}
